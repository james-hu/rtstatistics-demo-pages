<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Live usage statistics of mobile app LibBooks</title>
  <meta name="description" content="Live usage statistics of mobile app "LibBooks"">
  <meta name="author" content="James Hu">

  <script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>

  <!-- Load c3.css -->
  <link href="http://cdnjs.cloudflare.com/ajax/libs/c3/0.4.10/c3.min.css" rel="stylesheet" type="text/css">

  <!-- Load d3.js and c3.js -->
  <script src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.5.12/d3.min.js" charset="utf-8"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/c3/0.4.10/c3.min.js"></script>

  <!-- Load Google charts -->
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <!-- Load cjtsd.js and its dependencies -->
  <script src="http://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.6/moment.min.js"></script>
  <script src="https://npmcdn.com/cjtsd@^1.0.8/dist/cjtsd.min.js"></script>

  <!-- bootstrap -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

  <!-- slider component -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/6.1.5/css/bootstrap-slider.min.css" rel="stylesheet" type="text/css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/6.1.5/bootstrap-slider.min.js"></script>

</head>

<body>
  <h1> Demo - Live usage statistics of mobile app "LibBooks"</h1>
  <p>
  Charts below on this page show live statistics of the usage of "<a href="https://play.google.com/store/apps/details?id=net.sf.jabb.pri.lb" target="_blank">LibBooks</a>" - a mobile app helping people checking library book loans and reservations.
  </p>
  <p>
  Events generated by the mobile app are sent through REST API (POST <a href="https://api.rtstatistics.com/" target="_blank">https://api.rtstatistics.com/dataset/{id}/items</a>) directly from mobile devices. rtstatistics.com does the number crunching to generate the statistics. This page queries the statistics through REST API (GET <a href="https://api.rtstatistics.com/" target="_blank">https://api.rtstatistics.com/statistics/{id}/detail</a>). The delay from the event gets received to updated statistics can be queried is typically less than 1 second.
  </p>
  <p>
  Charts on this page use <a href="http://c3js.org/">c3.js</a>+<a href="https://d3js.org/">d3.js</a> or <a href="https://developers.google.com/chart/">Google Charts</a> for drawing the charts, and <a href="https://github.com/james-hu/cjtsd-js">cjtsd-js</a> is used for transforming the query results into the format that c3.js and Google Charts require.
  </p>
  <p>
  You can adjust the refresh interval of these charts manually. During refreshes, if new statistics are fetched from the server, the charts will reflect the changes. If you don't touch it for a few minutes, the interval will be automatically increased until reaching 60 seconds.
  </p>
  <p>
    Refresh interval (seconds): &nbsp;&nbsp;&nbsp;&nbsp;
    <input
      type="text"
      id="refreshIntervalSlider"
    >
  </p>
  <h3>Total event counts per 5 minutes (UTC)</h3>
  <div id="chartTotalEventCountsPer5MinUTC"></div>
  This chart shows total number of usage events collected from the mobile app per 5 minutes. Statistics of last 48 hours are shown.

  The chart is drawn with c3.js and displays UTC time.


  <h3>Unique users per 1 hour (Melbourne time)</h3>
  <div id="chartUniqueUsersPer1HourMelbourne"></div>
  Every event sent from the mobile app contains an installation id which is a UUID generated during installation. By counting the number of unique installation ids, we can find out how many unique users are actively using this mobile app.

  The chart shows number of unique users per 1 hour. Statistics of last 48 hours are shown.

  The chart is drawn with c3.js and displays Melbourne time (with Daylight saving observed when applicable).

  <h3>UpdateAll operation time (seconds) by number of library accounts (UTC)</h3>
  (using Google Charts)
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-3">
        <h4>Today</h4>
        <div id="chartUpdateAllTimeByLibraryAccountsTodayUTC">若在墙里可能看不见图</div>
      </div>
      <div class="col-md-3">
        <h4>Yesterday</h4>
        <div id="chartUpdateAllTimeByLibraryAccountsYesterdayUTC">若在墙里可能看不见图</div>
      </div>
      <div class="col-md-3">
        <h4>This month</h4>
        <div id="chartUpdateAllTimeByLibraryAccountsThisMonthUTC">若在墙里可能看不见图</div>
      </div>
      <div class="col-md-3">
        <h4>Last month</h4>
        <div id="chartUpdateAllTimeByLibraryAccountsLastMonthUTC">若在墙里可能看不见图</div>
      </div>
    </div>
  </div>
  Multiple library accounts can be configured in the mobile app. Loans and reservations of all library accounts are updated together in parallel. These charts show the minimal, maximal, and average time (number of seconds) used by the UpdateAll operation. Statistics for users with different numbers of library accounts are calculated separately.

  As you can see from the charts, time used by UpdateAll operation probably depends more on network condition and number of books involved rather than number of library accounts.

  The charts are drawn with Google Charts library and display UTC time.

  <script>
  var queryKey = "pvSq0wgTE9jK1FhSWy2hy71guTJRWTktHttGzY0uKA8bvf-kJXIE-i9Fi7imdilIQggZYL6pJqmTTQKrQRVStw";

  var googleChartsLibLoaded = false;

  var refreshIntervalSlider;
  var timeoutRefreshRefreshIntervalSlider;

  var chartTotalEventCountsPer5MinUTC;
  var timeoutRefreshTotalEventCountsPer5MinUTC;

  var chartUniqueUsersPer1HourMelbourne;
  var timeoutRefreshUniqueUsersPer1HourMelbourne;

  var chartUpdateAllTimeByLibraryAccountsTodayUTC;
  var timeoutRefreshUpdateAllTimeByLibraryAccountsTodayUTC;

  var chartUpdateAllTimeByLibraryAccountsYesterdayUTC;
  var timeoutRefreshUpdateAllTimeByLibraryAccountsYesterdayUTC;

  var chartUpdateAllTimeByLibraryAccountsThisMonthUTC;
  var timeoutRefreshUpdateAllTimeByLibraryAccountsThisMonthUTC;

  var chartUpdateAllTimeByLibraryAccountsLastMonthUTC;
  var timeoutRefreshUpdateAllTimeByLibraryAccountsLastMonthUTC;


  $(function(){
    bindChartsAndStartRefresh();
  });

  function bindChartsAndStartRefresh(){
    chartTotalEventCountsPer5MinUTC = c3.generate({
      bindto: '#chartTotalEventCountsPer5MinUTC',
      data: {
        x: 'time',
        xFormat: '%Y-%m-%d %H:%M',
        columns: [
        ],
        type: 'bar'
      },
      bar: {
        width: {
          ratio: 0.9
        }
      },
      axis: {
        x: {
          type: 'timeseries',
          tick: {
            count: 576,
            culling: {
              max: 3
            },
            format: '%Y-%m-%d %H:%M'
          }
        }
      }
    });

    chartUniqueUsersPer1HourMelbourne = c3.generate({
      bindto: '#chartUniqueUsersPer1HourMelbourne',
      data: {
        x: 'time',
        xFormat: '%Y-%m-%d %H:%M',
        columns: [
        ],
        type: 'bar'
      },
      bar: {
        width: {
          ratio: 0.9
        }
      },
      axis: {
        x: {
          type: 'timeseries',
          tick: {
            count: 48,
            culling: {
              max: 3
            },
            format: '%Y-%m-%d %H:00'
          }
        }
      }
    });

    startRefresh();
    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(function(){
      googleChartsLibLoaded = true;
    });
  }

  function startRefresh(){
    refreshIntervalSlider = new Slider("#refreshIntervalSlider", {
      min: 1,
      max: 60,
      value: 1,
      tooltip_position: "bottom"
    });
    refreshIntervalSlider.on("slideStop", onNewRefreshInterval);
    refreshIntervalSlider.on("slideEnabled", onNewRefreshInterval);

    onNewRefreshInterval();

    $("body").mousemove(function(){
      if (refreshIntervalSlider.getValue() > 1){
        refreshIntervalSlider.setValue(1);
        onNewRefreshInterval();
      }
    });
  }

  function onNewRefreshInterval(){
    clearTimeout(timeoutRefreshRefreshIntervalSlider);
    resetRefreshing();
    var seconds = refreshIntervalSlider.getValue();
    if (seconds < 60){
      timeoutRefreshRefreshIntervalSlider = setTimeout(function(){
        var seconds = refreshIntervalSlider.getValue();
        if (seconds < 60){
          refreshIntervalSlider.disable();
          if (seconds < 10){
            refreshIntervalSlider.setValue(10);
          }else if (seconds < 20){
            refreshIntervalSlider.setValue(20);
          }else if (seconds < 30){
            refreshIntervalSlider.setValue(30);
          }else if (seconds < 40){
            refreshIntervalSlider.setValue(40);
          }else if (seconds < 50){
            refreshIntervalSlider.setValue(50);
          }else{
            refreshIntervalSlider.setValue(60);
          }
          refreshIntervalSlider.enable();
        }
      }, 60000 * (2 + Math.floor(seconds/30)));  // increase values after n minutes
    }
  }

  function resetRefreshing(){
    clearTimeout(timeoutRefreshTotalEventCountsPer5MinUTC);
    updateTotalEventCountsPer5MinUTC();

    clearTimeout(timeoutRefreshUniqueUsersPer1HourMelbourne);
    updateUniqueUsersPer1HourMelbourne();

    clearTimeout(timeoutRefreshUpdateAllTimeByLibraryAccountsTodayUTC);
    updateUpdateAllTimeByLibraryAccountsTodayUTC();

    clearTimeout(timeoutRefreshUpdateAllTimeByLibraryAccountsYesterdayUTC);
    updateUpdateAllTimeByLibraryAccountsYesterdayUTC();

    clearTimeout(timeoutRefreshUpdateAllTimeByLibraryAccountsThisMonthUTC);
    updateUpdateAllTimeByLibraryAccountsThisMonthUTC();

    clearTimeout(timeoutRefreshUpdateAllTimeByLibraryAccountsLastMonthUTC);
    updateUpdateAllTimeByLibraryAccountsLastMonthUTC();
  }

  function formatTime(hourOffset, zoneOffset, format){
    if (zoneOffset === undefined){
      zoneOffset = 0;
    }
    var now = Date.now() + zoneOffset;
    if (format === undefined){
      format = "YYYYMMDDHHmm";
    }
    return moment(now + 1000*60*60*hourOffset).utc().format(format);
  }

  function updateTotalEventCountsPer5MinUTC(){
    var query;
    query = "https://api.rtstatistics.com/statistics/AA$S2hKMyHhKFbkP6MBEUuS$_zwu3bCXfwmLvUCf1hXo/detail?"
      + "_period=5 minutes"
      + "&_columns=count"
      + "&_from=" + formatTime(-48)
      + "&_to=" + formatTime(1)
      + "&api_key=" + queryKey;
    $.ajax(query)
      .done(function(result){
        if (result.result){
          var data = result.result;
          var timeCol = cjtsd.getFormattedTimestamps(data, 'YYYY-MM-DD HH:mm', 'time');
          var dataCol = cjtsd.prepend(data.c, 'Total number of events per 5 minutes')
          chartTotalEventCountsPer5MinUTC.load({
            columns: [
              timeCol,
              dataCol
            ]
          });
          $("#chartTotalEventCountsPer5MinUTC .tick line").css("opacity", 0);
        }else{
          if (console && console.log){
            console.log("No valid result for query '" + query + "', result: " + result);
          }
        }
      })
      .always(function(){
        var interval = 1000 * refreshIntervalSlider.getValue();
        timeoutRefreshTotalEventCountsPer5MinUTC = setTimeout(updateTotalEventCountsPer5MinUTC, interval);
      });
  }

  function updateUniqueUsersPer1HourMelbourne(){
    var query;
    query = "https://api.rtstatistics.com/statistics/AA$S2hKMyHhKFbkP6MBEUuS$QCg-eUgK5ERNyE1OWLQu/detail?"
      + "_period=1 hour"
      + "&_zone=Australia/Melbourne"
      + "&_columns=unique,values"
      + "&_from=" + formatTime(-48)
      + "&_to=" + formatTime(1)
      + "&api_key=" + queryKey;
    $.ajax(query)
      .done(function(result){
        if (result.result){
          var data = result.result;
          var timeCol = cjtsd.getFormattedTimestamps(data, 'YYYY-MM-DD HH:mm', 'time');
          var dataCol = cjtsd.prepend(data.n, 'Number of unique users per 1 hour')
          chartUniqueUsersPer1HourMelbourne.load({
            columns: [
              timeCol,
              dataCol
            ]
          });
          $("#chartUniqueUsersPer1HourMelbourne .tick line").css("opacity", 0);
        }else{
          if (console && console.log){
            console.log("No valid result for query '" + query + "', result: " + result);
          }
        }
      })
      .always(function(){
        var interval = 1000 * refreshIntervalSlider.getValue();
        timeoutRefreshUniqueUsersPer1HourMelbourne = setTimeout(updateUniqueUsersPer1HourMelbourne, interval);
      });
  }

  function updateUpdateAllTimeByLibraryAccountsTodayUTC(){
    updateUpdateAllTimeByLibraryAccountsUTC('chartUpdateAllTimeByLibraryAccountsTodayUTC', "day", 0, 24, function(interval){
      timeoutRefreshUpdateAllTimeByLibraryAccountsTodayUTC = setTimeout(updateUpdateAllTimeByLibraryAccountsTodayUTC, interval);
    });
  }

  function updateUpdateAllTimeByLibraryAccountsYesterdayUTC(){
    updateUpdateAllTimeByLibraryAccountsUTC('chartUpdateAllTimeByLibraryAccountsYesterdayUTC', "day", -24, 0, function(interval){
      timeoutRefreshUpdateAllTimeByLibraryAccountsYesterdayUTC = setTimeout(updateUpdateAllTimeByLibraryAccountsYesterdayUTC, interval);
    });
  }

  function updateUpdateAllTimeByLibraryAccountsThisMonthUTC(){
    updateUpdateAllTimeByLibraryAccountsUTC('chartUpdateAllTimeByLibraryAccountsThisMonthUTC', "month", 0, 30*24, function(interval){
      timeoutRefreshUpdateAllTimeByLibraryAccountsThisMonthUTC = setTimeout(updateUpdateAllTimeByLibraryAccountsThisMonthUTC, interval);
    });
  }

  function updateUpdateAllTimeByLibraryAccountsLastMonthUTC(){
    updateUpdateAllTimeByLibraryAccountsUTC('chartUpdateAllTimeByLibraryAccountsLastMonthUTC', "month", -30*24, 0, function(interval){
      timeoutRefreshUpdateAllTimeByLibraryAccountsLastMonthUTC = setTimeout(updateUpdateAllTimeByLibraryAccountsLastMonthUTC, interval);
    });
  }

  function updateUpdateAllTimeByLibraryAccountsUTC(chartObjName, periodUnit, fromHourOffset, toHourOffset, setTimerFunction){
    if (googleChartsLibLoaded){
      if (!window[chartObjName]){
        try{
          window[chartObjName] = new google.visualization.CandlestickChart(
            document.getElementById(chartObjName));
        }catch(err){
          window.console && console.log(err);
        }
      }
    }
    var chartObj = window[chartObjName];
    if(!chartObj){
      var interval = 1000 * refreshIntervalSlider.getValue();
      setTimerFunction(interval);
      return;
    }

    var timeFormatPattern = periodUnit == "day" ? "YYYYMMDD" : "YYYYMM";
    var query;
    query = "https://api.rtstatistics.com/statistics/AA$S2hKMyHhKFbkP6MBEUuS$Sdb3u_Nw8UOBzd9GKNeA/detail?"
      + "_period=1 " + periodUnit
      + "&_zone=UTC"
      + "&_columns=all"
      + "&_from=" + formatTime(fromHourOffset, 0, timeFormatPattern)
      + "&_to=" + formatTime(toHourOffset, 0, timeFormatPattern)
      + "&api_key=" + queryKey
      + "&numAccounts=";
    $.when($.ajax(query + "1"), $.ajax(query + "2"), $.ajax(query + "3"), $.ajax(query + "4"))
      .done(function(result1, result2, result3, result4){
        var data1 = result1[0].result;
        var data2 = result2[0].result;
        var data3 = result3[0].result;
        var data4 = result4[0].result;
        if (data1 && data2 && data3 && data4){
          var table = new google.visualization.DataTable();
          table.addColumn('string', "Number of accounts");
          table.addColumn('number', 'Seconds (Min)');
          table.addColumn('number', 'Seconds (Avg)');
          table.addColumn('number', 'Seconds (Avg)');
          table.addColumn('number', 'Seconds (Max)');
          cjtsd.setDataTableColumn(table, ["1 account", "2 accounts", "3 accounts", "4 accounts"], 0);
          cjtsd.setDataTableColumn(table, [].concat(data1.m || [null], data2.m || [null], data3.m || [null], data4.m || [null]), 1);
          cjtsd.setDataTableColumn(table, [].concat(data1.a || [null], data2.a || [null], data3.a || [null], data4.a || [null]), 2);
          cjtsd.setDataTableColumn(table, [].concat(data1.a || [null], data2.a || [null], data3.a || [null], data4.a || [null]), 3);
          cjtsd.setDataTableColumn(table, [].concat(data1.x || [null], data2.x || [null], data3.x || [null], data4.x || [null]), 4);

          chartObj.draw(table, {legend:'none', 'height':300});
        }else{
          window.console && console.log("No valid result for query '" + query + "', result1: " + result1 +
              ", result2: " + result2 + ", result3: " + result3 + ", result4: " + result4);
        }
      })
      .always(function(){
        var interval = 1000 * refreshIntervalSlider.getValue();
        setTimerFunction(interval);
      });
  }

  </script>
</body>
</html>
